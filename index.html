<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitoring Balita</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f1f5f9;
      padding: 40px;
      margin: 0;
      color: #1f2937;
    }
    body.dark {
      background-color: #0f172a;
      color: #f8fafc;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    input, select {
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      font-size: 15px;
      background-color: #ffffff;
    }
    .button-group {
      margin-top: 15px;
    }
    button {
      padding: 10px 24px;
      margin: 5px 10px 10px 0;
      background-color: #3b82f6;
      border: none;
      color: white;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #2563eb;
    }
    .btn-danger {
      background-color: #ef4444;
    }
    .btn-danger:hover {
      background-color: #dc2626;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      background-color: #ffffff;
      border-radius: 12px;
      overflow-x: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      font-size: 12px;
    }
    th, td {
      padding: 8px 10px;
      text-align: center;
      border-bottom: 1px solid #e2e8f0;
      white-space: nowrap;
    }
    th {
      background-color: #f8fafc;
      font-weight: 600;
      color: #1e293b;
    }
    .dark table, .dark th, .dark td {
      background-color: #1e293b;
      color: #f8fafc;
    }
    .badge-buruk {
      color: white;
      background-color: #dc2626;
      padding: 2px 8px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<h2>Form Monitoring Balita</h2>
<label><input type="checkbox" onclick="toggleDarkMode()"> Mode Gelap</label>

<div class="form-grid">
  <input type="text" id="nama" placeholder="Nama Balita">
  <select id="jenis_kelamin">
    <option value="laki">Laki-laki</option>
    <option value="perempuan">Perempuan</option>
  </select>
  <input type="number" id="umur" placeholder="Umur (bulan)">
  <input type="number" id="tb_akhir" placeholder="Tinggi Badan (cm)">
  <input type="number" id="bb_awal" placeholder="BB Awal (kg)">
  <input type="number" id="bb_akhir" placeholder="BB Akhir (kg)">
</div>

<div class="button-group">
  <button onclick="tambahData()">Tambah Data</button>
  <button onclick="exportExcel()">Export Excel</button>
  <button onclick="cetakPDF()">Cetak PDF</button>
</div>

<div id="tabelContainer">
  <table id="tabel">
    <thead>
      <tr>
        <th>Nama</th>
        <th>JK</th>
        <th>Umur</th>
        <th>BB Awal</th>
        <th>BB Akhir</th>
        <th>Kepatuhan PMT</th>
        <th>Z-Score BB/U</th>
        <th>Status Gizi</th>
        <th>Tinggi</th>
        <th>Z-Score TB/U</th>
        <th>Tanggal</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
const WHO_STANDARD = {
  laki: {
    bbu: { 8: { M: 8.6, SD: 0.93 }, 12: { M: 9.6, SD: 1.0 }, 13: { M: 9.8, SD: 1.02 } },
    tbu: { 67: { M: 7.7, SD: 0.5 }, 68: { M: 7.8, SD: 0.5 } }
  },
  perempuan: {
    bbu: { 8: { M: 7.9, SD: 0.84 }, 12: { M: 8.9, SD: 0.91 }, 13: { M: 9.1, SD: 0.92 } },
    tbu: { 67: { M: 7.4, SD: 0.48 }, 68: { M: 7.5, SD: 0.48 } }
  }
};

function toggleDarkMode() {
  document.body.classList.toggle('dark');
}

function hitungZScore(nilai, ref) {
  if (!ref) return "N/A";
  return ((nilai - ref.M) / ref.SD).toFixed(1);
}

function klasifikasiGizi(z) {
  if (z === "N/A") return "Tidak Tersedia";
  z = parseFloat(z);
  if (z < -3) return "<span class='badge-buruk'>Gizi Buruk</span>";
  if (z >= -3 && z < -2) return "Gizi Kurang";
  if (z >= -2 && z <= 2) return "Gizi Baik";
  if (z > 2) return "Gizi Lebih";
  return "-";
}

function hitungPersenPMT(bb_awal, bb_akhir) {
  let selisih = bb_akhir - bb_awal;
  if (selisih >= 0.8) return ">90%";
  if (selisih >= 0.4) return "60â€“90%";
  if (selisih >= 0.1) return "<60%";
  return "0%";
}

function ambilForm() {
  const nama = document.getElementById("nama").value;
  const jk = document.getElementById("jenis_kelamin").value;
  const umur = parseInt(document.getElementById("umur").value);
  const tinggi = parseFloat(document.getElementById("tb_akhir").value);
  const bb_awal = parseFloat(document.getElementById("bb_awal").value);
  const bb_akhir = parseFloat(document.getElementById("bb_akhir").value);
  const tanggal = new Date().toLocaleDateString();

  if (!nama || isNaN(umur) || isNaN(tinggi) || isNaN(bb_awal) || isNaN(bb_akhir)) {
    alert("Mohon lengkapi semua field.");
    return null;
  }

  const z_bbu = hitungZScore(bb_akhir, WHO_STANDARD[jk]?.bbu[umur]);
  const status = klasifikasiGizi(z_bbu);
  const z_tbu = hitungZScore(tinggi, WHO_STANDARD[jk]?.tbu[Math.round(tinggi)]);
  const pmt = hitungPersenPMT(bb_awal, bb_akhir);

  return { nama, jk, umur, tinggi, bb_awal, bb_akhir, z_bbu, status, z_tbu, pmt, tanggal };
}

function buatRowHTML(data) {
  return `
    <td>${data.nama}</td>
    <td>${data.jk}</td>
    <td>${data.umur}</td>
    <td>${data.bb_awal}</td>
    <td>${data.bb_akhir}</td>
    <td>${data.pmt}</td>
    <td>${data.z_bbu}</td>
    <td>${data.status}</td>
    <td>${data.tinggi}</td>
    <td>${data.z_tbu}</td>
    <td>${data.tanggal}</td>
    <td>
      <button class="btn-danger" onclick="hapusData(this)">Hapus</button>
      <button onclick="cetakPerBaris(this)">Cetak</button>
    </td>
  `;
}

function tambahData() {
  const data = ambilForm();
  if (!data) return;
  const tbody = document.querySelector("#tabel tbody");
  const row = tbody.insertRow();
  row.innerHTML = buatRowHTML(data);
  resetForm();
}

function hapusData(btn) {
  const row = btn.closest("tr");
  row.remove();
}

function resetForm() {
  ["nama", "umur", "tb_akhir", "bb_awal", "bb_akhir"].forEach(id => document.getElementById(id).value = "");
}

function exportExcel() {
  let wb = XLSX.utils.table_to_book(document.getElementById("tabel"), { sheet: "Monitoring" });
  XLSX.writeFile(wb, "monitoring_balita.xlsx");
}

function cetakPDF() {
  const element = document.getElementById("tabelContainer");
  html2pdf().set({
    margin: 0.5,
    filename: 'monitoring_balita.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
  }).from(element).save();
}

function cetakPerBaris(btn) {
  const row = btn.closest("tr").cloneNode(true);
  const table = document.createElement("table");
  table.appendChild(document.createElement("thead")).innerHTML = document.querySelector("thead").innerHTML;
  const tbody = document.createElement("tbody");
  tbody.appendChild(row);
  table.appendChild(tbody);
  html2pdf().from(table).set({ filename: 'rekap_balita.pdf' }).save();
}
</script>
</body>
</html>
